---
- name: "change owner cinder log directory"
  file:
    dest: "/var/log/cinder"
    state: "directory"
    owner: "cinder"
    group: "cinder"
    recurse: yes

- name: "set values to cinder config"
  ini_file:
    dest: "/etc/cinder/cinder.conf"
    section: "{{ item.section }}"
    option: "{{ item.option }}"
    value: "{{ item.value }}"
  with_items:
    - { section: "DEFAULT", option: "my_ip", value: "{{ contrail_address }}" }
    - { section: "DEFAULT", option: "rabbit_host", value: "{{ hostvars[groups['config'][0]]['contrail_address'] }}" }
    - { section: "DEFAULT", option: "rabbit_port", value: "5672" }
    - { section: "DEFAULT", option: "glance_host", value: "{{ hostvars[groups['openstack'][0]]['contrail_address'] }}" }
    - { section: "DEFAULT", option: "glance_port", value: "9292" }
    - { section: "database", option: "connection", value: "mysql://cinder:cinder@{{ hostvars[groups['openstack'][0]]['contrail_address'] }}/cinder?charset=utf8" }
    - { section: "database", option: "idle_timeout", value: "180" }
    - { section: "keystone_authtoken", option: "admin_tenant_name", value: "service" }
    - { section: "keystone_authtoken", option: "admin_user", value: "cinder" }
    - { section: "keystone_authtoken", option: "admin_password", value: "{{ contrail_admin_password }}" }
    - { section: "keystone_authtoken", option: "auth_protocol", value: "http" }

- name: "change database address if first node"
  ini_file:
    dest: "/etc/cinder/cinder.conf"
    section: "database"
    option: "connection"
    value: "mysql://cinder:cinder@127.0.0.1/cinder?charset=utf8"
  run_once: yes

- name: "sync database for cinder"
  shell: "cinder-manage db sync"
  run_once: yes

- name: "restart cinder"
  service:
    name: "cinder-{{ item }}"
    state: "restarted"
  with_items:
    - "api"
    - "scheduler"

- name: "delete cinder sqlite database"
  file:
    dest: "/var/lib/cinder/cinder.sqlite"
    state: "absent"
