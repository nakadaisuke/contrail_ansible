---
- name: "fix up mysql config"
  lineinfile:
    dest: "/etc/mysql/my.cnf"
    regexp: "^(\\s*#)?\\s*{{ item.regexp }}"
    line: "{{ item.line }}"
    insertafter: "[mysqld]"
  with_items:
    - { regexp: "bind-address", line: "#bind-address = 127.0.0.1" }
    - { regexp: "max_connections", line: "max_connections = 500" }
    - { regexp: "thread_cache", line: "thread_cache = 500" }
  run_once: yes

- name: "restart mysql"
  service:
    name: "mysql"
    state: "restarted"
  run_once: yes

- name: "set mysql root password"
  shell: "mysqladmin password {{ contrail_mysql_token }}"
  run_once: yes

- name: "create databases"
  mysql_db:
    name: "{{ item }}"
    encoding: "utf8"
    login_user: "root"
    login_password: "{{ contrail_mysql_token }}"
  with_items:
    - "keystone"
    - "glance"
    - "cinder"
    - "nova"
    - "heat"
  run_once: yes

- name: "create users for local"
  mysql_user:
    name: "{{ item }}"
    password: "{{ item }}"
    priv: "{{ item }}.*:ALL"
    login_user: "root"
    login_password: "{{ contrail_mysql_token }}"
  with_items:
    - "keystone"
    - "glance"
    - "cinder"
    - "nova"
    - "heat"
  run_once: yes

- name: "create users for remote"
  mysql_user:
    name: "{{ item }}"
    password: "{{ item }}"
    host: "%"
    priv: "{{ item }}.*:ALL"
    login_user: "root"
    login_password: "{{ contrail_mysql_token }}"
  with_items:
    - "keystone"
    - "glance"
    - "cinder"
    - "nova"
    - "heat"
  run_once: yes

- name: "create mysql token file"
  template:
    src: "templates/mysql-token.j2"
    dest: "/etc/contrail/mysql.token"
    mode: 0400
  run_once: yes
