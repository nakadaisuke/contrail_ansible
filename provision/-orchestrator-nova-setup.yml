---
- name: "change owner nova log directory"
  file:
    dest: "/var/log/nova"
    state: "directory"
    owner: "nova"
    group: "nova"
    recurse: yes

- name: "delete values from nova config"
  ini_file:
    dest: "/etc/nova/nova.conf"
    section: "{{ item.section }}"
    option: "{{ item.option }}"
  with_items:
    - { section: "DEFAULT", option: "quantum_admin_tenant_name" }
    - { section: "DEFAULT", option: "quantum_admin_username" }
    - { section: "DEFAULT", option: "quantum_admin_password" }
    - { section: "DEFAULT", option: "quantum_admin_auth_url" }
    - { section: "DEFAULT", option: "quantum_auth_strategy" }
    - { section: "DEFAULT", option: "quantum_url" }

- name: "set values to nova config"
  ini_file:
    dest: "/etc/nova/nova.conf"
    section: "{{ item.section }}"
    option: "{{ item.option }}"
    value: "{{ item.value }}"
  with_items:
    - { section: "DEFAULT", option: "libvirt_nonblocking", value: "True" }
    - { section: "DEFAULT", option: "libvirt_inject_partition", value: "-1" }
    - { section: "DEFAULT", option: "connection_type", value: "libvirt" }
    - { section: "DEFAULT", option: "rabbit_host", value: "{{ hostvars[groups['config'][0]]['contrail_address'] }}" }
    - { section: "DEFAULT", option: "rabbit_port", value: "5672" }
    - { section: "DEFAULT", option: "glance_host", value: "{{ hostvars[groups['openstack'][0]]['contrail_address'] }}" }
    - { section: "DEFAULT", option: "glance_port", value: "9292" }
    - { section: "DEFAULT", option: "neutron_admin_tenant_name", value: "service" }
    - { section: "DEFAULT", option: "neutron_admin_username", value: "neutron" }
    - { section: "DEFAULT", option: "neutron_admin_password", value: "{{ contrail_admin_password }}" }
    - { section: "DEFAULT", option: "neutron_admin_auth_url", value: "http://{{ hostvars[groups['openstack'][0]]['contrail_address'] }}:35357/v2.0/" }
    - { section: "DEFAULT", option: "neutron_url", value: "http://{{ hostvars[groups['config'][0]]['contrail_address'] }}:9696/" }
    - { section: "DEFAULT", option: "neutron_url_timeout", value: "300" }
    - { section: "DEFAULT", option: "security_group_api", value: "neutron" }
    - { section: "DEFAULT", option: "osapi_compute_workers", value: "40" }
    - { section: "DEFAULT", option: "service_neutron_metadata_proxy", value: "True" }
    - { section: "DEFAULT", option: "compute_driver", value: "libvirt.LibvirtDriver" }
    - { section: "DEFAULT", option: "libvirt_vif_driver", value: "nova_contrail_vif.contrailvif.VRouterVIFDriver" }
    - { section: "DEFAULT", option: "firewall_driver", value: "nova.virt.firewall.NoopFirewallDriver" }
    - { section: "DEFAULT", option: "service_down_time", value: "100000" }
    - { section: "DEFAULT", option: "novncproxy_port", value: "5999" }
    - { section: "DEFAULT", option: "novncproxy_host", value: "0.0.0.0" }
    - { section: "DEFAULT", option: "quota_instances", value: "100000" }
    - { section: "DEFAULT", option: "quota_cores", value: "100000" }
    - { section: "DEFAULT", option: "quota_ram", value: "10000000" }
    - { section: "DEFAULT", option: "network_api_class", value: "contrail_nova_networkapi.api.API" }
    - { section: "DEFAULT", option: "ec2_private_dns_show_ip", value: "False" }
    - { section: "DEFAULT", option: "auth_strategy", value: "keystone" }
    - { section: "conductor", option: "workers", value: "40" }
    - { section: "database", option: "connection", value: "mysql://nova:nova@{{ hostvars[groups['openstack'][0]]['contrail_address'] }}/nova?charset=utf8" }
    - { section: "database", option: "idle_timeout", value: "180" }
    - { section: "database", option: "max_retries", value: "-1" }
    - { section: "keystone_authtoken", option: "admin_tenant_name", value: "service" }
    - { section: "keystone_authtoken", option: "admin_user", value: "nova" }
    - { section: "keystone_authtoken", option: "admin_password", value: "{{ contrail_admin_password }}" }
    - { section: "keystone_authtoken", option: "auth_protocol", value: "http" }
    - { section: "keystone_authtoken", option: "auth_host", value: "{{ hostvars[groups['openstack'][0]]['contrail_address'] }}" }
    - { section: "keystone_authtoken", option: "signing_dir", value: "/tmp/keystone-signing-nova" }

- name: "change database address if first node"
  ini_file:
    dest: "/etc/nova/nova.conf"
    section: "database"
    option: "connection"
    value: "mysql://nova:nova@127.0.0.1/nova?charset=utf8"
  run_once: yes

- name: "sync database for nova"
  shell: "nova-manage db sync"
  run_once: yes

- name: "restart nova"
  service:
    name: "nova-{{ item }}"
    state: "restarted"
  with_items:
    - "api"
    - "objectstore"
    - "scheduler"
    - "console"
    - "consoleauth"
    - "novncproxy"
    - "conductor"

- name: "delete nova sqlite database"
  file:
    dest: "/var/lib/nova/nova.sqlite"
    state: "absent"
